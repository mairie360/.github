name: Check issues linked to project

on:
  workflow_dispatch:
  # schedule:
  #   - cron: '0 * * * *' # toutes les heures

jobs:
  check-project-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Query GitHub Project issues and Priority and Status fields
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GRAPH_QL_ACCESS_TOKEN }}
          script: |
            const projectId = "${{ vars.PROJECT_GITHUB_ID }}";

            const query = `
              query($projectId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    items(first: 20) {
                      nodes {
                        content {
                          ... on Issue {
                            title
                            number
                            state
                            createdAt
                          }
                        }
                        fieldValues(first: 10) {
                          nodes {
                            ... on ProjectV2ItemFieldSingleSelectValue {
                              name
                              field {
                                ... on ProjectV2SingleSelectField {
                                  name
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            const result = await github.graphql(query, { projectId });

            console.log("Issues in project with Priority and Status fields:");
            for (const item of result.node.items.nodes) {
              if (item.content) {
                const issue = item.content;
                console.log(`#${issue.number} - ${issue.title} [${issue.state}] - Created at: ${issue.createdAt}`);

                let priority = "N/A";
                let status = "N/A";

                for (const field of item.fieldValues.nodes) {
                  if (field.field) {
                    if (field.field.name === "Priority") {
                      priority = field.name;
                    } else if (field.field.name === "Status") {
                      status = field.name;
                    }
                  }
                }

                console.log(`   -> Priority: ${priority}`);
                console.log(`   -> Status: ${status}`);
              }
            }
